kind: pipeline
type: docker
name: webUITest

platform:
  os: linux
  arch: amd64

steps:
  - name: server
    image: node:14
    environment:
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_NAME: waveentry
      SERVER_PORT: 3001
      JWT_SECRET: very-secret
    commands:
      - git clone --single-branch -b master --depth 1 https://github.com/saw-jan/wave-entry-server.git /tmp/server
      - cd /tmp/server
      - ls
      - npm ci
      - npm run db:seed
      - npm start

  - name: web-client
    image: node:14
    environment:
      REACT_APP_SERVER_URI: http://server:3001
    commands:
      - npm ci
      - BROWSER=none npm start

  - name: acceptance-tests
    image: node:14
    environment:
      SERVER_URL: http://server:3001
      WEB_URL: http://web-client:3000
    commands:
      - npm run test:e2e tests/acceptance/features

services:
  - name: mongodb
  - image: mongo:focal

trigger:
  branch: master
